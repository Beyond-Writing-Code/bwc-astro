#!/bin/bash
# Pre-commit hook - runs quality checks before allowing commit

echo "üîç Running pre-commit checks..."

FAILED=0

# 1. Lint
echo "üìù Running ESLint..."
npm run lint --silent || { echo "‚ùå ESLint failed"; FAILED=1; }

# 2. Format check (with auto-fix attempt)
echo "üé® Checking formatting..."
if ! npm run format:check --silent; then
    echo "üîß Formatting issues found, auto-fixing..."
    npm run format --silent
    git add -u
    if ! npm run format:check --silent; then
        echo "‚ùå Formatting still failed after auto-fix"
        FAILED=1
    else
        echo "‚úÖ Formatting auto-fixed and staged"
    fi
fi

# 3. Type check
echo "üöÄ Running Astro type check..."
npm run type-check --silent || { echo "‚ùå Type check failed"; FAILED=1; }

# 4. Tests
echo "üß™ Running tests..."
TEST_OUTPUT=$(npm run test:run --silent 2>&1)
TEST_EXIT=$?
if [ $TEST_EXIT -ne 0 ]; then
    echo "‚ùå Tests failed"
    echo "$TEST_OUTPUT"
    FAILED=1
else
    # Only show warnings/errors from successful test runs
    echo "$TEST_OUTPUT" | grep -iE "(warn|error|‚ö†Ô∏è|‚ùå)" || true
fi

# 5. Build test
echo "üèóÔ∏è  Testing build..."
npm run build --silent || { echo "‚ùå Build failed"; FAILED=1; }

# 6. Security (warn only)
echo "üîí Security audit..."
npm run security:check --silent 2>/dev/null || echo "‚ö†Ô∏è  Security issues detected"

if [ $FAILED -ne 0 ]; then
    echo ""
    echo "‚ùå Pre-commit checks failed"
    echo "To bypass (not recommended): git commit --no-verify"
    exit 1
fi

echo "‚úÖ All checks passed!"
