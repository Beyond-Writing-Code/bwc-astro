name: Deploy to DreamHost

on:
  workflow_dispatch:
  workflow_run:
    workflows: ['CI']
    types: [completed]
    branches: [main]

permissions:
  contents: read

jobs:
  build:
    name: Build site
    runs-on: ubuntu-latest
    # Only run if CI workflow succeeded
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          # For workflow_run, checkout the commit that triggered CI
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build

      - name: Package build into tar.gz (preserves dotfiles)
        run: |
          set -euo pipefail
          TAR_NAME=site-dist.tar.gz
          tar -C dist -czf "${TAR_NAME}" .

      - name: Upload build artifact (tarball)
        uses: actions/upload-artifact@v6
        with:
          name: site-dist
          path: site-dist.tar.gz
          retention-days: 7

  deploy:
    name: Deploy to beyondwritingcode.com
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: Set deployment variables
        id: vars
        run: |
          echo "site_url=beyondwritingcode.com" >> $GITHUB_OUTPUT
          echo "site_url_full=https://www.beyondwritingcode.com" >> $GITHUB_OUTPUT

      - name: Download build artifact (tarball)
        uses: actions/download-artifact@v4
        with:
          name: site-dist
          path: .

      - name: Extract artifact to dist/
        run: |
          set -euo pipefail
          rm -rf dist
          mkdir -p dist
          TAR_NAME=site-dist.tar.gz
          if [ ! -f "${TAR_NAME}" ]; then
            echo "::error::Expected ${TAR_NAME} not found"
            ls -la
            exit 1
          fi
          tar -C dist -xzf "${TAR_NAME}"

      - name: Deploy to DreamHost via rsync over SSH
        env:
          REMOTE_PATH: ${{ secrets.DREAMHOST_MAIN_REMOTE_PATH }}
          REMOTE_USER: ${{ secrets.DREAMHOST_MAIN_SSH_USER }}
          REMOTE_HOST: ${{ secrets.DREAMHOST_SSH_HOST }}
          SSH_KEY: ${{ secrets.DREAMHOST_MAIN_SSH_PRIVATE_KEY }}
          SITE_URL: ${{ steps.vars.outputs.site_url }}
        run: |
          set -euo pipefail

          # Setup SSH key
          mkdir -p ~/.ssh
          printf "%s\n" "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Start SSH agent and add key
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/deploy_key

          # Add host to known_hosts
          ssh-keyscan -H "$REMOTE_HOST" >> ~/.ssh/known_hosts

          # Deploy
          echo "Deploying to ${SITE_URL}..."
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=yes" dist/ "${REMOTE_USER}@${REMOTE_HOST}:${REMOTE_PATH}"

          echo "âœ… Deployment successful!"

          # Cleanup: remove key and stop agent
          ssh-add -D || true
          rm -f ~/.ssh/deploy_key
          if [ -n "${SSH_AGENT_PID:-}" ]; then
            kill "$SSH_AGENT_PID" || true
          fi

      - name: Deployment summary
        run: |
          echo "## Deployment Complete ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Site deployed to: **${{ steps.vars.outputs.site_url }}**" >> $GITHUB_STEP_SUMMARY
          echo "Deployed from commit: \`${{ github.event.workflow_run.head_sha || github.sha }}\`" >> $GITHUB_STEP_SUMMARY

  review:
    name: Review deployed site
    runs-on: ubuntu-latest
    needs: deploy
    permissions:
      contents: write # Allow committing review results

    steps:
      - name: Set deployment variables
        id: vars
        run: |
          echo "site_url_full=https://www.beyondwritingcode.com" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_sha || github.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Wait for deployment to settle
        run: sleep 30

      - name: Run site review
        run: node scripts/review-site.js ${{ steps.vars.outputs.site_url_full }}
        continue-on-error: true # Don't fail if issues found

      - name: Commit review results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -f REVIEW_ISSUES.md ]; then
            git add REVIEW_ISSUES.md
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "Update site review [skip ci]"
              # Push to main branch explicitly (we're in detached HEAD)
              git push origin HEAD:main
            fi
          fi

      - name: Review summary
        if: always()
        run: |
          if [ -f REVIEW_ISSUES.md ]; then
            echo "## Site Review Results ðŸ“‹" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            cat REVIEW_ISSUES.md >> $GITHUB_STEP_SUMMARY
          fi
